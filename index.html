<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chronometer - UKMO & CNTIC</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 50%, #ffffff 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            color: #2c3e50;
        }

        header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            box-shadow: 0 2px 20px rgba(0, 0, 0, 0.08);
            padding: 1.5rem 2rem;
            border-bottom: 2px solid rgba(52, 152, 219, 0.1);
        }

        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 2rem;
        }

        .logo-box {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 0.8rem 1.5rem;
            background: white;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
            transition: all 0.3s ease;
        }

        .logo-box:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.12);
        }

        .logo-box img {
            height: 50px;
            width: auto;
        }

        .logo-text {
            font-weight: 600;
            color: #2c3e50;
            font-size: 0.9rem;
        }

        main {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2rem;
        }

        .timer-container {
            background: white;
            padding: 3rem;
            border-radius: 30px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
            text-align: center;
            max-width: 700px;
            width: 100%;
        }

        h1 {
            font-size: 2rem;
            color: #2c3e50;
            margin-bottom: 2rem;
            font-weight: 700;
        }

        .timer-display {
            font-size: 5rem;
            font-weight: 700;
            color: #3498db;
            font-family: 'Courier New', monospace;
            margin: 2rem 0;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
            letter-spacing: 0.1em;
        }

        .milliseconds {
            font-size: 3rem;
            color: #7f8c8d;
        }

        .controls {
            display: flex;
            gap: 1rem;
            justify-content: center;
            margin: 2rem 0;
            flex-wrap: wrap;
        }

        button {
            padding: 1rem 2.5rem;
            font-size: 1.1rem;
            font-weight: 600;
            border: none;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .start-btn {
            background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
            color: white;
        }

        .start-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(46, 204, 113, 0.4);
        }

        .pause-btn {
            background: linear-gradient(135deg, #f39c12 0%, #f1c40f 100%);
            color: white;
        }

        .pause-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(243, 156, 18, 0.4);
        }

        .reset-btn {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            color: white;
        }

        .reset-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(231, 76, 60, 0.4);
        }

        .fullscreen-btn {
            background: linear-gradient(135deg, #9b59b6 0%, #8e44ad 100%);
            color: white;
        }

        .fullscreen-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(155, 89, 182, 0.4);
        }

        .lap-btn {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            color: white;
        }

        .lap-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(52, 152, 219, 0.4);
        }

        button:active {
            transform: translateY(0);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .laps-container {
            margin-top: 2rem;
            max-height: 300px;
            overflow-y: auto;
        }

        .laps-title {
            font-size: 1.2rem;
            color: #2c3e50;
            margin-bottom: 1rem;
            font-weight: 600;
        }

        .lap-item {
            display: flex;
            justify-content: space-between;
            padding: 0.8rem 1.5rem;
            margin: 0.5rem 0;
            background: #f8f9fa;
            border-radius: 10px;
            transition: all 0.3s ease;
        }

        .lap-item:hover {
            background: #e9ecef;
            transform: translateX(5px);
        }

        .lap-number {
            font-weight: 600;
            color: #3498db;
        }

        .lap-time {
            font-family: 'Courier New', monospace;
            color: #2c3e50;
        }

        footer {
            background: rgba(255, 255, 255, 0.95);
            padding: 1.5rem;
            text-align: center;
            color: #7f8c8d;
            border-top: 2px solid rgba(52, 152, 219, 0.1);
        }

        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                gap: 1rem;
            }

            .timer-display {
                font-size: 3.5rem;
            }

            .milliseconds {
                font-size: 2rem;
            }

            button {
                padding: 0.8rem 1.5rem;
                font-size: 0.9rem;
            }

            .timer-container {
                padding: 2rem 1.5rem;
            }

            .time-input-group input {
                width: 60px;
                padding: 0.6rem;
                font-size: 1.2rem;
            }
        }

        .laps-container::-webkit-scrollbar {
            width: 8px;
        }

        .laps-container::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }

        .laps-container::-webkit-scrollbar-thumb {
            background: #3498db;
            border-radius: 10px;
        }

        .laps-container::-webkit-scrollbar-thumb:hover {
            background: #2980b9;
        }

        /* Alarm Styles */
        .alarm-container {
            margin-top: 2rem;
            padding: 1.5rem;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 20px;
            border: 2px solid #3498db;
            animation: fadeIn 0.5s ease;
        }

        .alarm-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .alarm-header h3 {
            color: #2c3e50;
            font-size: 1.3rem;
            font-weight: 600;
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 30px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: 0.4s;
            border-radius: 30px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 22px;
            width: 22px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: 0.4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
        }

        input:checked + .slider:before {
            transform: translateX(30px);
        }

        .alarm-mode-selector {
            display: flex;
            justify-content: center;
            gap: 2rem;
            margin-bottom: 1.5rem;
        }

        .radio-option {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
            padding: 0.8rem 1.5rem;
            background: white;
            border-radius: 10px;
            border: 2px solid #ddd;
            transition: all 0.3s ease;
            font-weight: 600;
        }

        .radio-option:hover {
            border-color: #3498db;
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(52, 152, 219, 0.2);
        }

        .radio-option input[type="radio"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .radio-option input[type="radio"]:checked + span {
            color: #3498db;
        }

        .radio-option:has(input[type="radio"]:checked) {
            border-color: #3498db;
            background: linear-gradient(135deg, #ebf5fb 0%, #d6eaf8 100%);
        }

        .interval-duration-container {
            margin-bottom: 1.5rem;
            padding: 1.5rem;
            background: white;
            border-radius: 15px;
            animation: fadeIn 0.3s ease;
        }

        .interval-time-inputs {
            margin-bottom: 1rem;
        }

        .duration-slider-group {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .duration-slider-group label {
            font-weight: 600;
            color: #2c3e50;
            text-align: center;
            font-size: 1.1rem;
        }

        .duration-slider-group label span {
            color: #3498db;
            font-size: 1.3rem;
        }

        .duration-slider-group input[type="range"] {
            width: 100%;
            height: 8px;
            border-radius: 5px;
            background: linear-gradient(to right, #3498db 0%, #2ecc71 100%);
            outline: none;
            -webkit-appearance: none;
            cursor: pointer;
        }

        .duration-slider-group input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: white;
            border: 3px solid #3498db;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(52, 152, 219, 0.4);
            transition: all 0.3s ease;
        }

        .duration-slider-group input[type="range"]::-webkit-slider-thumb:hover {
            transform: scale(1.2);
            box-shadow: 0 4px 12px rgba(52, 152, 219, 0.6);
        }

        .duration-slider-group input[type="range"]::-moz-range-thumb {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: white;
            border: 3px solid #3498db;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(52, 152, 219, 0.4);
            transition: all 0.3s ease;
        }

        .duration-slider-group input[type="range"]::-moz-range-thumb:hover {
            transform: scale(1.2);
            box-shadow: 0 4px 12px rgba(52, 152, 219, 0.6);
        }

        .slider-markers {
            display: flex;
            justify-content: space-between;
            padding: 0 5px;
            font-size: 0.75rem;
            color: #7f8c8d;
            font-weight: 600;
        }

        .alarm-inputs {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .time-input-group {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .time-input-group input {
            width: 70px;
            padding: 0.8rem;
            font-size: 1.5rem;
            text-align: center;
            border: 2px solid #3498db;
            border-radius: 10px;
            font-weight: 600;
            font-family: 'Courier New', monospace;
            transition: all 0.3s ease;
        }

        .time-input-group input:focus {
            outline: none;
            border-color: #2ecc71;
            box-shadow: 0 0 15px rgba(46, 204, 113, 0.3);
        }

        .time-input-group label {
            margin-top: 0.5rem;
            font-size: 0.8rem;
            color: #7f8c8d;
            font-weight: 600;
        }

        .colon {
            font-size: 2rem;
            font-weight: bold;
            color: #3498db;
            margin-bottom: 1.5rem;
        }

        .alarm-status {
            text-align: center;
            padding: 0.8rem;
            background: white;
            border-radius: 10px;
            margin: 1rem 0;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .alarm-status.active {
            background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%);
            color: white;
            animation: pulse 2s infinite;
        }

        .sound-selector {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 1rem;
            margin-top: 1rem;
        }

        .sound-selector label {
            font-weight: 600;
            color: #2c3e50;
        }

        .sound-selector select {
            padding: 0.6rem 1.2rem;
            border: 2px solid #3498db;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            background: white;
            transition: all 0.3s ease;
        }

        .sound-selector select:focus {
            outline: none;
            border-color: #2ecc71;
            box-shadow: 0 0 15px rgba(46, 204, 113, 0.3);
        }

        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(46, 204, 113, 0.7);
            }
            50% {
                transform: scale(1.02);
                box-shadow: 0 0 0 10px rgba(46, 204, 113, 0);
            }
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes alarmTrigger {
            0%, 100% {
                background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            }
            50% {
                background: linear-gradient(135deg, #f39c12 0%, #f1c40f 100%);
            }
        }

        .timer-container.alarm-triggered {
            animation: alarmTrigger 1s infinite;
        }

        .timer-display.alarm-triggered {
            animation: shake 0.5s infinite;
            color: white !important;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }

        /* Notification Modal */
        .notification-modal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 3rem;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            z-index: 1000;
            text-align: center;
            animation: modalPop 0.5s ease;
        }

        .notification-modal.show {
            display: block;
        }

        @keyframes modalPop {
            0% {
                transform: translate(-50%, -50%) scale(0.5);
                opacity: 0;
            }
            100% {
                transform: translate(-50%, -50%) scale(1);
                opacity: 1;
            }
        }

        .notification-modal h2 {
            color: #e74c3c;
            font-size: 2.5rem;
            margin-bottom: 1rem;
        }

        .notification-modal p {
            color: #2c3e50;
            font-size: 1.2rem;
            margin-bottom: 2rem;
        }

        .notification-modal button {
            padding: 1rem 3rem;
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            color: white;
            border: none;
            border-radius: 15px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .notification-modal button:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 20px rgba(231, 76, 60, 0.4);
        }

        .overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 999;
        }

        .overlay.show {
            display: block;
        }

        /* Fullscreen styles */
        body:fullscreen,
        body:-webkit-full-screen,
        body:-moz-full-screen {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
        }

        body:fullscreen .timer-container,
        body:-webkit-full-screen .timer-container,
        body:-moz-full-screen .timer-container {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            border: 2px solid rgba(255, 255, 255, 0.2);
            max-width: 90%;
            padding: 4rem;
        }

        body:fullscreen .timer-display,
        body:-webkit-full-screen .timer-display,
        body:-moz-full-screen .timer-display {
            font-size: 8rem;
            color: #ffffff;
            text-shadow: 0 0 30px rgba(52, 152, 219, 0.8);
        }

        body:fullscreen .milliseconds,
        body:-webkit-full-screen .milliseconds,
        body:-moz-full-screen .milliseconds {
            font-size: 5rem;
            color: rgba(255, 255, 255, 0.8);
        }

        body:fullscreen h1,
        body:-webkit-full-screen h1,
        body:-moz-full-screen h1 {
            color: #ffffff;
        }

        body:fullscreen .laps-title,
        body:-webkit-full-screen .laps-title,
        body:-moz-full-screen .laps-title {
            color: #ffffff;
        }

        body:fullscreen .lap-item,
        body:-webkit-full-screen .lap-item,
        body:-moz-full-screen .lap-item {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        body:fullscreen .lap-number,
        body:-webkit-full-screen .lap-number,
        body:-moz-full-screen .lap-number {
            color: #3498db;
        }

        body:fullscreen .lap-time,
        body:-webkit-full-screen .lap-time,
        body:-moz-full-screen .lap-time {
            color: #ffffff;
        }
    </style>
</head>
<body>
    <header>
        <div class="header-content">
            <div class="logo-box">
                <img src="universite-kasdi-merbah-ouargla-91530.png" alt="University Logo">
                <span class="logo-text">Universit√© Kasdi Merbah</span>
            </div>
            <h1 style="margin: 0; font-size: 1.5rem;">‚è±Ô∏è Chronometer</h1>
            <div class="logo-box">
                <img src="cntic_icon.jpg" alt="CNTIC Logo">
                <span class="logo-text">CNTIC Club</span>
            </div>
        </div>
    </header>

    <main>
        <div class="timer-container">
            <h1>Precision Timer</h1>
            
            <div class="timer-display">
                <span id="display">00:00:00</span>
                <span class="milliseconds" id="milliseconds">.000</span>
            </div>

            <div class="controls">
                <button class="start-btn" id="startBtn">Start</button>
                <button class="pause-btn" id="pauseBtn" disabled>Pause</button>
                <button class="lap-btn" id="lapBtn" disabled>Lap</button>
                <button class="reset-btn" id="resetBtn">Reset</button>
                <button class="fullscreen-btn" id="fullscreenBtn">‚õ∂ Fullscreen</button>
            </div>

            <div class="alarm-container" id="alarmContainer">
                <div class="alarm-header">
                    <h3>‚è∞ Set Alarm</h3>
                    <label class="switch">
                        <input type="checkbox" id="alarmToggle">
                        <span class="slider"></span>
                    </label>
                </div>
                
                <div class="alarm-mode-selector">
                    <label class="radio-option">
                        <input type="radio" name="alarmMode" value="single" checked>
                        <span>Single Alarm</span>
                    </label>
                    <label class="radio-option">
                        <input type="radio" name="alarmMode" value="interval">
                        <span>Interval Soni</span>
                    </label>
                </div>

                <div class="alarm-inputs" id="singleAlarmInputs">
                    <div class="time-input-group">
                        <input type="number" id="alarmHours" min="0" max="23" value="0" placeholder="HH">
                        <label>Hours</label>
                    </div>
                    <span class="colon">:</span>
                    <div class="time-input-group">
                        <input type="number" id="alarmMinutes" min="0" max="59" value="0" placeholder="MM">
                        <label>Minutes</label>
                    </div>
                    <span class="colon">:</span>
                    <div class="time-input-group">
                        <input type="number" id="alarmSeconds" min="0" max="59" value="10" placeholder="SS">
                        <label>Seconds</label>
                    </div>
                </div>

                <div class="interval-duration-container" id="intervalDurationContainer" style="display: none;">
                    <div class="interval-time-inputs">
                        <label style="font-weight: 600; color: #2c3e50; margin-bottom: 1rem; display: block; text-align: center;">Interval Every:</label>
                        <div class="alarm-inputs" style="margin-bottom: 0;">
                            <div class="time-input-group">
                                <input type="number" id="intervalHours" min="0" max="23" value="0" placeholder="HH">
                                <label>Hours</label>
                            </div>
                            <span class="colon">:</span>
                            <div class="time-input-group">
                                <input type="number" id="intervalMinutes" min="0" max="59" value="0" placeholder="MM">
                                <label>Minutes</label>
                            </div>
                            <span class="colon">:</span>
                            <div class="time-input-group">
                                <input type="number" id="intervalSeconds" min="0" max="59" value="10" placeholder="SS">
                                <label>Seconds</label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="duration-slider-group" style="margin-top: 1.5rem;">
                        <label for="soniDuration">Sound Duration: <span id="soniDurationValue">3</span> seconds</label>
                        <input type="range" id="soniDuration" min="1" max="10" value="3" step="1">
                        <div class="slider-markers">
                            <span>1s</span>
                            <span>2s</span>
                            <span>3s</span>
                            <span>4s</span>
                            <span>5s</span>
                            <span>6s</span>
                            <span>7s</span>
                            <span>8s</span>
                            <span>9s</span>
                            <span>10s</span>
                        </div>
                    </div>
                </div>
                <div class="alarm-status" id="alarmStatus">
                    <span id="alarmStatusText">Alarm disabled</span>
                </div>
                <div class="sound-selector">
                    <label>Alarm Sound:</label>
                    <select id="soundSelect">
                        <option value="cntic-alarm">Cntic</option>
                        <option value="beep">Beep</option>
                        <option value="bell">Bell</option>
                        <option value="chime">Chime</option>
                    </select>
                </div>
            </div>

            <div class="laps-container" id="lapsContainer" style="display: none;">
                <div class="laps-title">üìä Lap Times</div>
                <div id="lapsList"></div>
            </div>
        </div>
    </main>

    <footer>
        <p>¬© 2025 University Kasdi Merbah - CNTIC Club | Ouargla, Algeria</p>
    </footer>

    <div class="overlay" id="overlay"></div>
    <div class="notification-modal" id="notificationModal">
        <h2>‚è∞ Time's Up!</h2>
        <p>Your alarm time has been reached!</p>
        <button id="dismissAlarm">Dismiss</button>
    </div>

    <script>
      let startTime = 0;
      let elapsedTime = 0;
      let timerInterval;
      let isRunning = false;
      let lapCounter = 0;
      let alarmEnabled = false;
      let alarmTime = 0;
      let alarmTriggered = false;
      let audioContext;
      let currentSound = 'cntic-alarm';
      let alarmMode = 'single'; // 'single' or 'interval'
      let lastAlarmTrigger = 0; // Track last alarm trigger time for intervals
      let intervalSoniCount = 0; // Count how many times interval soni has played
      let soniDuration = 3; // How long the sound plays (in seconds)
      let soniTimeout = null; // Timeout for stopping the sound

      // Add an Audio object for the WAV file
      const wavAlarm = new Audio('cntic-alarm.wav');
      wavAlarm.loop = true; // loop until dismissed

      const display = document.getElementById('display');
      const milliseconds = document.getElementById('milliseconds');
      const startBtn = document.getElementById('startBtn');
      const pauseBtn = document.getElementById('pauseBtn');
      const lapBtn = document.getElementById('lapBtn');
      const resetBtn = document.getElementById('resetBtn');
      const fullscreenBtn = document.getElementById('fullscreenBtn');
      const lapsContainer = document.getElementById('lapsContainer');
      const lapsList = document.getElementById('lapsList');
      const alarmToggle = document.getElementById('alarmToggle');
      const alarmHours = document.getElementById('alarmHours');
      const alarmMinutes = document.getElementById('alarmMinutes');
      const alarmSeconds = document.getElementById('alarmSeconds');
      const alarmStatus = document.getElementById('alarmStatus');
      const alarmStatusText = document.getElementById('alarmStatusText');
      const soundSelect = document.getElementById('soundSelect');
      const notificationModal = document.getElementById('notificationModal');
      const overlay = document.getElementById('overlay');
      const dismissAlarm = document.getElementById('dismissAlarm');
      const timerContainer = document.querySelector('.timer-container');
      const alarmModeRadios = document.querySelectorAll('input[name="alarmMode"]');
      const singleAlarmInputs = document.getElementById('singleAlarmInputs');
      const intervalDurationContainer = document.getElementById('intervalDurationContainer');
      const intervalHours = document.getElementById('intervalHours');
      const intervalMinutes = document.getElementById('intervalMinutes');
      const intervalSeconds = document.getElementById('intervalSeconds');
      const soniDurationSlider = document.getElementById('soniDuration');
      const soniDurationValue = document.getElementById('soniDurationValue');

      // Ensure cntic-alarm option exists
      (function ensureOption() {
          const exists = Array.from(soundSelect.options).some(o => o.value === 'cntic-alarm');
          if (!exists) {
              const opt = document.createElement('option');
              opt.value = 'cntic-alarm';
              opt.textContent = 'CNTIC Alarm';
              soundSelect.appendChild(opt);
          }
      })();

      function formatTime(ms) {
          const totalSeconds = Math.floor(ms / 1000);
          const hours = Math.floor(totalSeconds / 3600);
          const minutes = Math.floor((totalSeconds % 3600) / 60);
          const seconds = totalSeconds % 60;
          const millisecond = ms % 1000;

          return {
              time: `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`,
              ms: `.${String(millisecond).padStart(3, '0')}`
          };
      }

      function updateDisplay() {
          const currentTime = Date.now();
          elapsedTime = currentTime - startTime;
          const formatted = formatTime(elapsedTime);
          display.textContent = formatted.time;
          milliseconds.textContent = formatted.ms;

          // Check if alarm should trigger
          if (alarmEnabled && isRunning) {
              if (alarmMode === 'single') {
                  // Single alarm mode - trigger once
                  if (!alarmTriggered && elapsedTime >= alarmTime) {
                      triggerAlarm();
                  }
              } else if (alarmMode === 'interval') {
                  // Interval mode - trigger every alarmTime milliseconds
                  if (elapsedTime >= alarmTime) {
                      const intervalsPassed = Math.floor(elapsedTime / alarmTime);
                      const expectedTriggers = intervalsPassed;
                      
                      // Check if we need to trigger a new interval
                      if (intervalSoniCount < expectedTriggers) {
                          intervalSoniCount = expectedTriggers;
                          triggerIntervalSoni();
                      }
                  }
              }
          }
      }

      function start() {
          if (!isRunning) {
              startTime = Date.now() - elapsedTime;
              timerInterval = setInterval(updateDisplay, 10);
              isRunning = true;
              
              startBtn.disabled = true;
              pauseBtn.disabled = false;
              lapBtn.disabled = false;
              startBtn.textContent = 'Resume';
          }
      }

      function pause() {
          if (isRunning) {
              clearInterval(timerInterval);
              isRunning = false;
              
              startBtn.disabled = false;
              pauseBtn.disabled = true;
              lapBtn.disabled = true;
          }
      }

      function reset() {
          clearInterval(timerInterval);
          isRunning = false;
          elapsedTime = 0;
          lapCounter = 0;
          alarmTriggered = false;
          lastAlarmTrigger = 0;
          intervalSoniCount = 0;
          
          display.textContent = '00:00:00';
          milliseconds.textContent = '.000';
          lapsList.innerHTML = '';
          lapsContainer.style.display = 'none';
          
          startBtn.disabled = false;
          pauseBtn.disabled = true;
          lapBtn.disabled = true;
          startBtn.textContent = 'Start';

          // Remove alarm animation and stop any playing audio
          timerContainer.classList.remove('alarm-triggered');
          display.classList.remove('alarm-triggered');

          stopWavIfPlaying();
      }

      function addLap() {
          if (isRunning) {
              lapCounter++;
              const formatted = formatTime(elapsedTime);
              
              const lapItem = document.createElement('div');
              lapItem.className = 'lap-item';
              lapItem.innerHTML = `
                  <span class="lap-number">Lap ${lapCounter}</span>
                  <span class="lap-time">${formatted.time}${formatted.ms}</span>
              `;
              
              lapsList.insertBefore(lapItem, lapsList.firstChild);
              lapsContainer.style.display = 'block';
          }
      }

      function toggleFullscreen() {
          if (!document.fullscreenElement && !document.webkitFullscreenElement && !document.mozFullScreenElement) {
              // Enter fullscreen
              if (document.documentElement.requestFullscreen) {
                  document.documentElement.requestFullscreen();
              } else if (document.documentElement.webkitRequestFullscreen) {
                  document.documentElement.webkitRequestFullscreen();
              } else if (document.documentElement.mozRequestFullScreen) {
                  document.documentElement.mozRequestFullScreen();
              }
              fullscreenBtn.textContent = '‚õ∂ Exit Fullscreen';
          } else {
              // Exit fullscreen
              if (document.exitFullscreen) {
                  document.exitFullscreen();
              } else if (document.webkitExitFullscreen) {
                  document.webkitExitFullscreen();
              } else if (document.mozCancelFullScreen) {
                  document.mozCancelFullScreen();
              }
              fullscreenBtn.textContent = '‚õ∂ Fullscreen';
          }
      }

      // Listen for fullscreen changes
      document.addEventListener('fullscreenchange', () => {
          if (!document.fullscreenElement) {
              fullscreenBtn.textContent = '‚õ∂ Fullscreen';
          }
      });

      document.addEventListener('webkitfullscreenchange', () => {
          if (!document.webkitFullscreenElement) {
              fullscreenBtn.textContent = '‚õ∂ Fullscreen';
          }
      });

      document.addEventListener('mozfullscreenchange', () => {
          if (!document.mozFullScreenElement) {
              fullscreenBtn.textContent = '‚õ∂ Fullscreen';
          }
      });

      startBtn.addEventListener('click', start);
      pauseBtn.addEventListener('click', pause);
      resetBtn.addEventListener('click', reset);
      lapBtn.addEventListener('click', addLap);
      fullscreenBtn.addEventListener('click', toggleFullscreen);

      // Alarm functionality
      alarmModeRadios.forEach(radio => {
          radio.addEventListener('change', function() {
              alarmMode = this.value;
              
              // Toggle visibility of inputs
              if (alarmMode === 'single') {
                  singleAlarmInputs.style.display = 'flex';
                  intervalDurationContainer.style.display = 'none';
              } else {
                  singleAlarmInputs.style.display = 'none';
                  intervalDurationContainer.style.display = 'block';
              }
              
              updateAlarmTime();
              // Reset interval counter when mode changes
              intervalSoniCount = 0;
              lastAlarmTrigger = 0;
          });
      });

      // Soni duration slider
      soniDurationSlider.addEventListener('input', function() {
          soniDuration = parseInt(this.value);
          soniDurationValue.textContent = soniDuration;
      });

      // Interval time inputs
      intervalHours.addEventListener('input', updateAlarmTime);
      intervalMinutes.addEventListener('input', updateAlarmTime);
      intervalSeconds.addEventListener('input', updateAlarmTime);

      function updateAlarmTime() {
          if (alarmMode === 'single') {
              const hours = parseInt(alarmHours.value) || 0;
              const minutes = parseInt(alarmMinutes.value) || 0;
              const seconds = parseInt(alarmSeconds.value) || 0;
              alarmTime = (hours * 3600 + minutes * 60 + seconds) * 1000;
          } else {
              // Interval mode uses Hours:Minutes:Seconds inputs
              const hours = parseInt(intervalHours.value) || 0;
              const minutes = parseInt(intervalMinutes.value) || 0;
              const seconds = parseInt(intervalSeconds.value) || 0;
              alarmTime = (hours * 3600 + minutes * 60 + seconds) * 1000;
          }
          
          if (alarmEnabled) {
              const formatted = formatTime(alarmTime);
              if (alarmMode === 'single') {
                  alarmStatusText.textContent = `Alarm set for: ${formatted.time}`;
              } else {
                  alarmStatusText.textContent = `Interval Soni every: ${formatted.time}`;
              }
          }
      }

      alarmToggle.addEventListener('change', function() {
          alarmEnabled = this.checked;
          alarmTriggered = false;
          intervalSoniCount = 0;
          lastAlarmTrigger = 0;
          
          if (alarmEnabled) {
              updateAlarmTime();
              alarmStatus.classList.add('active');
              alarmHours.disabled = true;
              alarmMinutes.disabled = true;
              alarmSeconds.disabled = true;
              intervalHours.disabled = true;
              intervalMinutes.disabled = true;
              intervalSeconds.disabled = true;
              soniDurationSlider.disabled = true;
              alarmModeRadios.forEach(r => r.disabled = true);
          } else {
              alarmStatus.classList.remove('active');
              alarmStatusText.textContent = 'Alarm disabled';
              alarmHours.disabled = false;
              alarmMinutes.disabled = false;
              alarmSeconds.disabled = false;
              intervalHours.disabled = false;
              intervalMinutes.disabled = false;
              intervalSeconds.disabled = false;
              soniDurationSlider.disabled = false;
              alarmModeRadios.forEach(r => r.disabled = false);
              timerContainer.classList.remove('alarm-triggered');
              display.classList.remove('alarm-triggered');
              stopWavIfPlaying();
          }
      });

      alarmHours.addEventListener('input', updateAlarmTime);
      alarmMinutes.addEventListener('input', updateAlarmTime);
      alarmSeconds.addEventListener('input', updateAlarmTime);

      soundSelect.addEventListener('change', function() {
          currentSound = this.value;
      });

      function playSound(type) {
          if (type === 'cntic-alarm') {
              const p = wavAlarm.play();
              if (p && typeof p.catch === 'function') p.catch(() => {});
              return;
          }

          if (!audioContext) {
              audioContext = new (window.AudioContext || window.webkitAudioContext)();
          }

          const oscillator = audioContext.createOscillator();
          const gainNode = audioContext.createGain();
          
          oscillator.connect(gainNode);
          gainNode.connect(audioContext.destination);

          switch(type) {
              case 'beep':
                  oscillator.frequency.value = 800;
                  oscillator.type = 'square';
                  gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                  gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
                  oscillator.start(audioContext.currentTime);
                  oscillator.stop(audioContext.currentTime + 0.5);
                  break;
              case 'bell':
                  oscillator.frequency.value = 1000;
                  oscillator.type = 'sine';
                  gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                  gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 1);
                  oscillator.start(audioContext.currentTime);
                  oscillator.stop(audioContext.currentTime + 1);
                  break;
              case 'chime':
                  oscillator.frequency.value = 523.25;
                  oscillator.type = 'sine';
                  gainNode.gain.setValueAtTime(0.2, audioContext.currentTime);
                  gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 1.5);
                  oscillator.start(audioContext.currentTime);
                  oscillator.stop(audioContext.currentTime + 1.5);
                  
                  setTimeout(() => {
                      const osc2 = audioContext.createOscillator();
                      const gain2 = audioContext.createGain();
                      osc2.connect(gain2);
                      gain2.connect(audioContext.destination);
                      osc2.frequency.value = 659.25;
                      osc2.type = 'sine';
                      gain2.gain.setValueAtTime(0.2, audioContext.currentTime);
                      gain2.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 1.5);
                      osc2.start(audioContext.currentTime);
                      osc2.stop(audioContext.currentTime + 1.5);
                  }, 200);
                  break;
          }
      }

      function triggerAlarm() {
          alarmTriggered = true;
          
          timerContainer.classList.add('alarm-triggered');
          display.classList.add('alarm-triggered');
          
          overlay.classList.add('show');
          notificationModal.classList.add('show');
          
          if (currentSound === 'cntic-alarm') {
              const p = wavAlarm.play();
              if (p && typeof p.catch === 'function') p.catch(() => {});
          } else {
              const soundInterval = setInterval(() => {
                  if (!alarmTriggered || !notificationModal.classList.contains('show')) {
                      clearInterval(soundInterval);
                      return;
                  }
                  playSound(currentSound);
              }, 1000);
              playSound(currentSound);
          }

          pause();
      }

      function triggerIntervalSoni() {
          timerContainer.classList.add('alarm-triggered');
          display.classList.add('alarm-triggered');
          
          // Clear any existing timeout
          if (soniTimeout) {
              clearTimeout(soniTimeout);
          }
          
          // Remove visual effect after 500ms (brief flash)
          setTimeout(() => {
              timerContainer.classList.remove('alarm-triggered');
              display.classList.remove('alarm-triggered');
          }, 500);
          
          if (currentSound === 'cntic-alarm') {
              const tempWav = new Audio('cntic-alarm.wav');
              tempWav.loop = false;
              const p = tempWav.play();
              if (p && typeof p.catch === 'function') p.catch(() => {});
              
              // Stop the sound after soniDuration seconds
              soniTimeout = setTimeout(() => {
                  tempWav.pause();
                  tempWav.currentTime = 0;
              }, soniDuration * 1000);
          } else {
              // Play sound repeatedly for the duration
              let soundCount = 0;
              const maxSounds = Math.ceil(soniDuration); // Number of beeps based on duration
              
              const soundInterval = setInterval(() => {
                  if (soundCount >= maxSounds) {
                      clearInterval(soundInterval);
                      return;
                  }
                  playSound(currentSound);
                  soundCount++;
              }, 1000); // Play every second
              
              playSound(currentSound); // Play first sound immediately
          }
          
          alarmStatusText.textContent = `Interval Soni #${intervalSoniCount} (every ${intervalDuration}s, plays ${soniDuration}s)`;
      }

      function stopWavIfPlaying() {
          try {
              if (!wavAlarm.paused) {
                  wavAlarm.pause();
                  wavAlarm.currentTime = 0;
              }
          } catch (err) {
              // ignore errors
          }
      }

      dismissAlarm.addEventListener('click', function() {
          overlay.classList.remove('show');
          notificationModal.classList.remove('show');
          timerContainer.classList.remove('alarm-triggered');
          display.classList.remove('alarm-triggered');
          alarmToggle.checked = false;
          alarmEnabled = false;
          alarmStatus.classList.remove('active');
          alarmStatusText.textContent = 'Alarm disabled';
          alarmHours.disabled = false;
          alarmMinutes.disabled = false;
          alarmSeconds.disabled = false;
          intervalDurationSlider.disabled = false;
          soniDurationSlider.disabled = false;
          alarmModeRadios.forEach(r => r.disabled = false);

          stopWavIfPlaying();
          alarmTriggered = false;
          intervalSoniCount = 0;
          lastAlarmTrigger = 0;
          
          // Clear any active soni timeout
          if (soniTimeout) {
              clearTimeout(soniTimeout);
              soniTimeout = null;
          }
      });

      // Keyboard shortcuts
      document.addEventListener('keydown', (e) => {
          if (e.code === 'Space') {
              e.preventDefault();
              if (!isRunning && !startBtn.disabled) {
                  start();
              } else if (isRunning) {
                  pause();
              }
          } else if (e.code === 'KeyR') {
              reset();
          } else if (e.code === 'KeyL' && isRunning) {
              addLap();
          } else if (e.code === 'KeyF') {
              toggleFullscreen();
          }
      });
  </script>

</body>
</html>
